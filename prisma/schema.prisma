// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Gender {
  MALE
  FEMALE
  OTHERS
}

enum UserStates {
  ACTIVE
  INACTIVE
}

enum PlanType {
  FREE
  MONTH_PAY
  YEAR_PAY
  SOLD
}

enum ChatType {
  INTERNAL
  CUSTOMER
}

enum MessageSenderType {
  USER
  CUSTOMER
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

model CompanyConfig {
  id                Int     @id @default(autoincrement())
  isCompanyWentTour Boolean @default(false)
  domain            String  @unique
  themeSetting      Json?   @default("{}")
  downTime          Boolean @default(false)
}

model PlanHistory {
  id         Int      @id @default(autoincrement())
  isActive   Boolean  @default(true)
  version    Decimal  @default(1.0)
  tierOfPlan PlanType
  startDate  DateTime @default(now())
  endDate    DateTime
  companyId  Int
  company    Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model Company {
  id               Int     @id @default(autoincrement())
  name             String
  address1         String
  address2         String?
  logoUrl          String?
  email            String  @unique
  phone            String  @unique
  gstinNumber      String?
  sacNumber        String?
  panNumber        String?
  esicNumber       String?
  epfNumber        String?
  serviceTaxNumber String?
  websiteLink      String?
  ownerUserId      Int

  documets               String[]                 @default([])
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  users                  User[]
  PunchLog               PunchLog[]
  WorkHoursConfiguration WorkHoursConfiguration[]
  particularDateConfigs  ParticularDateConfig[]
  salaryDesigns          SalaryDesign[]
  roles                  Role[]
  planHistories          PlanHistory[]
  companyGalleries       CompanyGallery[]
  rolePermissions        RolePermission[]
  timeLine               timeLine[]
  media                  media[]
  policies               policy[]
  Customer               Customer[]
  chats                  Chat[]
  gallery                Gallery[]
  notes                  Notes[]
}

model RolePermission {
  id Int @id @default(autoincrement())

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])

  key   String
  label String

  parentId Int?
  parent   RolePermission?  @relation("PermissionTree", fields: [parentId], references: [id])
  children RolePermission[] @relation("PermissionTree")

  access Boolean @default(false)

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  @@unique([roleId, key, parentId])
  @@index([companyId])
}

model Role {
  id         Int    @id @default(autoincrement())
  name       String @default("Owner")
  privileges Json   @default("{}")
  users      User[]

  companyId      Int
  company        Company          @relation(fields: [companyId], references: [id])
  RolePermission RolePermission[]

  @@index([companyId])
}

model User {
  id              Int        @id @default(autoincrement())
  name            String
  empCode         String
  adharNumber     String?    @unique
  uanNumber       String?    @unique
  bankAccount     String?
  address         String?
  city            String?
  pinCode         String?
  state           String?
  country         String?
  email           String?    @unique
  bloodGroup      String?
  ifscCode        String?
  gender          Gender?
  epfNumber       String?
  esicNumber      String?
  mobileNumber    String?    @unique
  password        String
  SecondaryMobile String?
  isDetele        Boolean    @default(false)
  status          UserStates @default(ACTIVE)
  documets        String[]   @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  WorkHoursConfigurationId Int?
  companyId                Int?
  company                  Company?          @relation(fields: [companyId], references: [id])
  role                     Role?             @relation(fields: [roleId], references: [id])
  roleId                   Int?
  punchId                  Int?
  PunchLog                 PunchLog?         @relation(fields: [punchId], references: [id])
  chatParticipants         ChatParticipant[]
  messages                 Message[]
  messageReads             MessageRead[]

  @@unique([companyId, empCode])
  @@unique([companyId, uanNumber])
  @@index([companyId])
}

model OtpStroe {
  id         Int      @id @default(autoincrement())
  email      String
  otp        String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  isVerified Boolean  @default(false)
}

model CompanyGallery {
  id         Int     @id @default(autoincrement())
  mediaUrl   String
  folderName String
  companyId  Int
  company    Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

enum workHoursModal {
  GENERAL_TIME_COVER
  FULL_DAY_TIME_COVER
  SHIFT_TIME_COVER
  DAY_WHAT_EVER_TIME_COVER
}

model BankDetails {
  id          Int    @id @default(autoincrement())
  purpose     String
  bankName    String
  bankAccount String @unique
  ifsc        String @unique
  companyId   Int

  @@index([companyId])
}

model WorkHoursConfiguration {
  id                        Int            @id @default(autoincrement())
  workHoursModal            workHoursModal @default(GENERAL_TIME_COVER)
  startTime                 String         @default("10:00")
  endTime                   String         @default("17:00")
  workingDurationMinutesMin Int            @default(60)
  workingDurationMintesMax  Int            @default(480)
  shiftTimes                String[]       @default([])
  weeklyOffDays             Int[]          @default([6, 7])

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model ParticularDateConfig {
  id          Int      @id @default(autoincrement())
  date        DateTime
  reason      String
  description String

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

enum PunchLogType {
  IN
  OUT
  JUSTIFY
  PERMISION
  LEAVE
  LOGFIX
}

model PunchLog {
  id        Int          @id @default(autoincrement())
  userId    Int
  punchIn   DateTime?
  punchOut  DateTime?
  remarks   PunchLogType
  updatedBy Int
  companyId Int
  company   Company      @relation(fields: [companyId], references: [id])
  users     User[]

  @@index([userId])
  @@index([companyId])
}

model SalaryDesign {
  id Int @id @default(autoincrement())

  components Json?
  formulas   Json?

  gross_vite_Amount    Float
  total_vite_Deduction Float
  net_vite_Pay         Float

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // @@index([employeeId])
  @@index([companyId])
}

model attendanceDesignModal {
  id Int @id @default(autoincrement())

  // totalWorkingday
  // totalPresntda
  // totalHoursWorked  
  // 
}

model timeLine {
  id          Int      @id @default(autoincrement())
  date        DateTime
  name        String
  description String?

  roleAccess Int[]

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("timeline")
}

model policy {
  id          Int    @id @default(autoincrement())
  name        String
  description String
  roleAccess  Int[]
  mediaId     Int[]

  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model media {
  id        Int     @id @default(autoincrement())
  fileName  String
  mimeType  String?
  size      Int
  url       String
  r2Key     String
  type      String
  companyId Int
  company   Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model Customer {
  id        Int     @id @default(autoincrement())
  companyId Int
  name      String
  phone     String?
  email     String?

  createdAt DateTime @default(now())

  company      Company           @relation(fields: [companyId], references: [id])
  participants ChatParticipant[]
  messages     Message[]

  @@index([companyId])
}

model Chat {
  id        Int      @id @default(autoincrement())
  companyId Int
  type      ChatType
  status    String   @default("OPEN") // OPEN | CLOSED
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])

  participants ChatParticipant[]
  messages     Message[]

  @@index([companyId])
  @@index([companyId, type])
}

model ChatParticipant {
  id        Int @id @default(autoincrement())
  chatId    Int
  companyId Int

  userId     Int?
  customerId Int?

  // used ONLY for customer unread count
  lastReadAt DateTime?

  joinedAt DateTime @default(now())

  chat     Chat      @relation(fields: [chatId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([chatId, userId])
  @@index([chatId, customerId])
  @@index([companyId])
}

model Message {
  id        Int @id @default(autoincrement())
  chatId    Int
  companyId Int

  senderType       MessageSenderType
  senderUserId     Int?
  senderCustomerId Int?

  messageType MessageType @default(TEXT)
  content     String
  createdAt   DateTime    @default(now())

  chat     Chat      @relation(fields: [chatId], references: [id])
  user     User?     @relation(fields: [senderUserId], references: [id])
  customer Customer? @relation(fields: [senderCustomerId], references: [id])

  reads MessageRead[]

  @@index([chatId])
  @@index([companyId])
  @@index([chatId, createdAt])
}

model MessageRead {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  readAt    DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([userId])
}

model Notes {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  startDate DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model Gallery {
  id        Int      @id @default(autoincrement())
  tag       String   @unique
  mediaId   Int
  mediaUrl  String   @default("")
  type      String   @default("DOC")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}
